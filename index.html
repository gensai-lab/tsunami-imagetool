<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>みんなの減災ラボ - 津波マップ生成ツール</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; display: flex; font-family: "Helvetica Neue", Arial, sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        #sidebar { width: 320px; height: 100vh; overflow-y: auto; background: #252525; padding: 15px; box-sizing: border-box; border-right: 1px solid #444; z-index: 1000; }
        #map-container { flex-grow: 1; position: relative; background: #104080; } 
        #map { width: 100%; height: 100vh; background: transparent; }
        
        /* バージョン表記のスタイル */
        .version-info { font-size: 11px; color: #888; text-align: right; margin-bottom: 5px; }
        
        .area-item { margin-bottom: 8px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .save-btn { width: 100%; padding: 12px; background: #28a745; color: white; border: none; cursor: pointer; margin-bottom: 20px; font-weight: bold; border-radius: 4px; }
        select { background: #333; color: white; border: 1px solid #555; padding: 3px; border-radius: 3px; }
        h3 { border-bottom: 2px solid #007bff; padding-bottom: 5px; font-size: 16px; margin-top: 0; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="version-info">Version 1.1.0</div>
    <button class="save-btn" onclick="saveImage()">PNG画像を生成・保存</button>
    <h3>津波予報区の設定</h3>
    <div id="controls">データを読み込み中...</div>
</div>

<div id="map-container">
    <div id="map"></div>
</div>

<script>
    const COLORS = {
        'none': 'transparent',
        'advisory': '#faff00', // 注意報
        'warning': '#ff2800',  // 警報
        'major': '#ff00ff'     // 大特警
    };

    // 重要度ランク（重なり順の制御用）
    const RANK = { 'none': 0, 'advisory': 1, 'warning': 2, 'major': 3 };

    const BASE_WEIGHT = 14; 
    const SUB_WEIGHT = 7; 

    var map = L.map('map', { zoomSnap: 0.1, attributionControl: false, zoomControl: false }).setView([36.5, 137.0], 5.5);
    var areaData = {};

    // 1. 都道府県境界（背景）
    fetch('prefectures.json').then(res => res.json()).then(data => {
        const layerName = Object.keys(data.objects)[0];
        const geoData = topojson.feature(data, data.objects[layerName]);
        L.geoJSON(geoData, {
            style: { color: "#444", weight: 1, fillColor: "#ccc", fillOpacity: 1 }
        }).addTo(map);
    }).catch(e => console.log("都道府県背景なし"));

    // 2. 津波予報区
    fetch('areas.json').then(res => res.json()).then(data => {
        const layerName = Object.keys(data.objects)[0];
        const geoData = topojson.feature(data, data.objects[layerName]);
        
        // 境界線を綺麗に見せるために2層構造にする（下層に黒い縁取り用レイヤーを自動生成も可能ですが、
        // 今回はシンプルに描画順を制御します）
        const geoJsonLayer = L.geoJSON(geoData, {
            style: { fillColor: 'transparent', fillOpacity: 0, weight: 1.5, color: '#666', lineJoin: 'round', lineCap: 'round' },
            onEachFeature: function (feature, layer) {
                const name = feature.properties.name || feature.properties.NAM || "不明";
                areaData[name] = { layer: layer, status: 'none' };
            }
        }).addTo(map);
        createControls();
    });

    function createControls() {
        const container = document.getElementById('controls');
        container.innerHTML = '';
        Object.keys(areaData).sort().forEach(name => {
            const div = document.createElement('div');
            div.className = 'area-item';
            div.innerHTML = `<span>${name}</span><select onchange="updateArea('${name}', this.value)"><option value="none">ー</option><option value="advisory">注意報</option><option value="warning">警報</option><option value="major">大特警</option></select>`;
            container.appendChild(div);
        });
    }

    function updateArea(name, status) {
        const item = areaData[name];
        if(!item) return;
        item.status = status;

        // すべてのレイヤーを再描画して、重なり順を正しく保つ
        // (重要度が高いものを常に上に持ってくる処理)
        renderAllLayers();
    }

    function renderAllLayers() {
        // 重なり順を制御するために、ランク順に並べ替えて bringToFront する
        const sortedAreas = Object.values(areaData).sort((a, b) => RANK[a.status] - RANK[b.status]);
        
        sortedAreas.forEach(item => {
            const status = item.status;
            if (status === 'none') {
                item.layer.setStyle({ color: '#666', weight: 1.5, opacity: 1 });
            } else {
                const weightValue = (status === 'major') ? BASE_WEIGHT : SUB_WEIGHT;
                item.layer.setStyle({
                    color: COLORS[status],
                    weight: weightValue,
                    opacity: 1,
                    lineJoin: 'round',
                    lineCap: 'round',
                    // ここで少しだけ影（縁取り）をつけて隣との境界を出す
                    dashArray: null
                });
                item.layer.bringToFront();
            }
        });
    }

    function saveImage() {
        const container = document.querySelector("#map-container");
        const btn = document.querySelector(".save-btn");
        btn.innerText = "生成中...";
        html2canvas(container, { useCORS: true, scale: 2 }).then(canvas => {
            const link = document.createElement("a");
            link.download = `tsunami_map_v1.1.0_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            btn.innerText = "PNG画像を生成・保存";
        });
    }
</script>
</body>
</html>
